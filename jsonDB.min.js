$.fn.serializeObject=function(){var o={};var a=this.serializeArray();$.each(a,function(){if(o[this.name]!==undefined){if(!o[this.name].push)o[this.name]=[o[this.name]];o[this.name].push(this.value||"")}else o[this.name]=this.value||""});return o};
var jsonDB={that:this,loadedDatbases:{},__os:function(){var OSName="Unknown OS";if(navigator.appVersion.indexOf("Win")!==-1)OSName="Windows";if(navigator.appVersion.indexOf("Mac")!==-1)OSName="MacOS";if(navigator.appVersion.indexOf("X11")!==-1)OSName="UNIX";if(navigator.appVersion.indexOf("Linux")!==-1)OSName="Linux";return OSName},utils:{setKey:function(key,value,targetObject){var keys=key.split("/"),obj=targetObject||window,keyPart;keys.shift();while((keyPart=keys.shift())&&keys.length){keyPart=
keyPart.replace("[","").replace("]","");obj=obj[keyPart]}obj[keyPart]=value},UUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})},getKey:function(key,o){function find(Obj,key){for(var i in Obj){console.log("key",i,"!=",key);if(i==key){console.log("got key",i);if(typeof Obj[i]=="object")return JSON.stringify(Obj[i]);else return Obj[i]}else if(typeof Obj[i]=="object")return find(Obj[i],key)}}if(~key.indexOf("/")){console.log();
var keys=key.split("/"),obj=o||window,keyPart;if(keys[0]==="")keys.shift();while((keyPart=keys.shift())&&keys.length){keyPart=keyPart.replace("[","").replace("]","");obj=obj[keyPart]}return typeof obj[keyPart]=="object"?JSON.stringify(obj[keyPart]):obj[keyPart]}else return find(o)}},__getLocalPath:function(file){splitter=this.__os()=="Windows"?"\\":"/";localPath=$.twFile.convertUriToLocalPath(document.location.href);WinNetworkDrive=localPath.indexOf("\\\\")===0?true:false;localPath=localPath.split(splitter);
console.log(localPath);delete localPath[localPath.length-1];localPath=localPath.join(splitter);if(WinNetworkDrive)localPath="\\\\"+localPath;return localPath+file},DB:function(DB){path=this.__getLocalPath(DB);console.log("load",path);tmp=$.twFile.load(path);console.log(tmp);tmp=JSON.parse(tmp);return new this.__DB(tmp,path)},__DB:function(DB,path){this.__path=path;this.__db=DB;this.write=function(){$.twFile.save(this.__path,JSON.stringify(this.__db))};this.getPath=function(key){return jsonDB.utils.getKey(key,
this.__db)};this.addRecord=function(Record){this.__db[jsonDB.utils.UUID()]=Record.Obj;this.query=jsonDB.__QueryDB(this)};this.save=function(){this.write()};this.query=new jsonDB.__QueryDB(this)},__QueryDB:function(db){this.result=[];this.selectors="";this.db=db.__db;this.select=function(keys){this.selectors=keys;this.result=this.db;return this};this.where=function(whereClauses,ANDOR){var ao=ANDOR||"OR";var currResults=this.results;function OR(obj,wc){var ret=[];for(var w in wc)for(var r in obj){var val=
typeof wc[w][2]=="object"?JSON.stringify(wc[w][2]):wc[w][2];var key=wc[w][0];if(wc[w][1]=="="||wc[w][1]=="=="){if(jsonDB.utils.getKey(key,obj[r])==val)ret.push(obj[r])}else if(wc[w][1]=="<"){if(jsonDB.utils.getKey(key,obj[r])<val)ret.push(obj[r])}else if(wc[w][1]==">"){if(jsonDB.utils.getKey(key,obj[r])>val)ret.push(obj[r])}else if(wc[w][1]=="<="){if(jsonDB.utils.getKey(key,obj[r])<=val)ret.push(obj[r])}else if(wc[w][1]==">="){if(jsonDB.utils.getKey(key,obj[r])>val)ret.push(obj[r])}else if(wc[w][1]==
"!"||wc[w][1]=="!="){if(jsonDB.utils.getKey(key,obj[r])!=val)ret.push(obj[r])}else if(wc[w][1]=="LIKE"||wc[w][1]=="~"){var getkey=jsonDB.utils.getKey(key,obj[r]);getkey=typeof getkey=="undefined"?"":getkey;if(~getkey.toLowerCase().indexOf(val.toLowerCase()))ret.push(obj[r])}else throw"jsonDB.DB.q.where:OR:Unknown operator:"+wc[w][1];}return ret}function AND(obj,wc){var ret=obj;for(var a in wc)ret=OR(ret,[wc[a]]);return ret}if(ao=="OR")this.result=OR(this.result,whereClauses);else if(ao=="AND")this.result=
AND(this.result,whereClauses);return this};this._where=function(key,val){var currResults=[];for(var i in this.result)if(this.__getKey(this.result[i],key)==val){console.log(i,this.result[i]);currResults.push(this.result[i]);console.log(currResults)}else if(typeof this.__getKey(this.result[i],key)=="object"&&JSON.stringify(this.__getKey(this.result[i],key))==val)currResults.push(this.result[i]);this.result=currResults;return this};this.done=function(){var ret;if(this.selectors=="*")ret=this.result;
else if(typeof this.selectors=="string")ret=this.result[this.selectors];else if(this.selectors instanceof Array){ret=[];for(var r in this.result)for(var s in this.selectors)ret.push({r:this.result[r][s]})}return ret};this.sortBy=function(key,ordr){var order=ordr||"asc";var path=key;function sorter(a,b){pa=jsonDB.utils.getKey(path,a);pb=jsonDB.utils.getKey(path,b);if(pa<pb)return-1;else if(pa>pb)return 1;else return 0}result=this.done();return(order="asc")?result.sort(sorter(a,b)):result.sort(sorter(a,
b)).reverse()};this.__getKey=function(obj,key){function find(Obj,key){for(var i in Obj){console.log("key",i);if(i==key){console.log("got key",i);if(typeof Obj[i]=="object")return JSON.stringify(Obj[i]);else return Obj[i]}else if(typeof Obj[i]=="object")return find(Obj[i],key)}}return find(obj,key)}},jsonDBRecordObj:function(RecordObjFile,raw){Obj=$.twFile.load(this.__getLocalPath(RecordObjFile));return raw?Obj:JSON.parse(Obj)},jsonDBRecord:function(RecordObj){var parent=this;this.recordObj=jsonDB.jsonDBRecordObj(RecordObj,
true);this.Obj=JSON.parse(this.recordObj);this.ObjReplacesHTMLInput={"(str)":'<input type="text" name="-UUID-" data-path="-PATH-"/>',"(uuid)":'<input type="text" name="-UUID-" data-path="-PATH-" value="'+jsonDB.utils.UUID()+'" disabled />',"(bool)":'<ul><li>true: <input data-path="-PATH-" type="radio" name="-UUID-" value="true"/></li><li>false:<input type="radio" data-path="-PATH-" name="-UUID-" value="false"/></li></ul>',"(int)":'<input type="text" name="-UUID-" data-path="-PATH-"/>'};var html="";
this.createForm=function(appendTo){path="/";function generateForm(Obj,findReplaceMatches,p,a){var html="";var path=p||"";var array=a||false;var me="";for(var i in Obj)if(typeof Obj[i]=="object"){if(array)me="["+i+"]";else me=i;if(Obj[i]instanceof Array)array=true;d=generateForm(Obj[i],findReplaceMatches,path+"/"+me,array);html+="<li>"+i+":<ul>"+d+"</ul></li>"}else if(typeof Obj[i]=="string"){id=jsonDB.utils.UUID();html+="<li>"+i+":"+findReplaceMatches[Obj[i]].replace("-UUID-",id).replace("-PATH-",
path+"/"+i).replace("-PATH-",path+"/"+i)+"</li>"}return html}result=generateForm(this.Obj,this.ObjReplacesHTMLInput);formid=jsonDB.utils.UUID();html='<form id="'+formid+'"><ul>'+result+'</ul><input type="submit" value="save"><form>';$(appendTo).append(html);$("#"+formid).on("submit",function(e){e.preventDefault();$.each($("#"+formid).serializeArray(),function(){path=$("input[name="+this.name+"]").attr("data-path");jsonDB.utils.setKey(path,this.value,parent.Obj)});$("#"+formid).remove()})}}};